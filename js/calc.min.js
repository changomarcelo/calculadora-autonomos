var GANANCIA_NO_IMPONIBLE = [];
GANANCIA_NO_IMPONIBLE[2016] = 42318;
GANANCIA_NO_IMPONIBLE[2017] = 51967;

var DEDUCCION_ESPECIAL = [];
DEDUCCION_ESPECIAL[2016] = 42318;
DEDUCCION_ESPECIAL[2017] = 51967;

var DEDUCCION_CONYUGUE = [];
DEDUCCION_CONYUGUE[2016] = 39778;
DEDUCCION_CONYUGUE[2017] = 48447;

var DEDUCCION_HIJO = [];
DEDUCCION_HIJO[2016] = 19889;
DEDUCCION_HIJO[2017] = 24432;

// para estos parámetros no tengo los valores 2017
var SEGURO_RETIRO_MAX = 1261.16;

var SERVICIO_DOMESTICO_MAX = [];
SERVICIO_DOMESTICO_MAX [2016] = 42318;
SERVICIO_DOMESTICO_MAX [2017] = 51967;

var ALQUILER_MAX = [];
ALQUILER_MAX[2016] = 0;
ALQUILER_MAX[2017] = 51967;


var SEGURO_VIDA_MAX = 996.23;
var INTERESES_MAX = 20000;
var PORCENTAJE_DONACIONES = 5;
var PORCENTAJE_CUOTAS_MEDICAS = 5;
var PORCENTAJE_HONORARIOS_MEDICOS = 5;

// valores 2016
var minimos = [];
minimos[2016] = [0, 10000, 20000, 30000, 60000, 90000, 120000];
minimos[2017] = [0, 20000, 40000, 60000, 80000, 120000, 160000, 240000, 320000];

var porcentajes = [];
porcentajes[2016] = [9, 14, 19, 23, 27, 31, 35];
porcentajes[2017] = [5, 9, 12, 15, 19, 23, 27, 31, 35];

var bases = [];
bases[2016] = [0, 900, 2300, 4200, 11100, 19200, 28500];
bases[2017] = [0, 1000, 2800, 5200, 8200, 15800, 25000, 46600, 71400];

var APORTES_AUT = [1198.08, 1470.72, 1608.60, 1966.08, 2150.40, 2941.44, 3217.20, 4911.36, 5371.80, 6869.76, 9818.88, 10739.40, 14734.08, 18432, 18432];
// no tengo los valores 2017

var periodo = 0;
if($("#radio_2016").is(":checked"))
	periodo = 2016;
else
	periodo = 2017;

console.debug('Periodo: '+ periodo);

$(function() {
	$('#deduccionEspecial').text('- $'+ DEDUCCION_ESPECIAL[periodo].toFixed(2));
	$('#gananciaNoImponible').text('- $'+ GANANCIA_NO_IMPONIBLE[periodo].toFixed(2));

    $("#calcular").click(function() {
  		calcular_aut();
	});
	
	$("#radio_2016").click(function() {
  		calcular_aut();
	});
	
	$("#radio_2017").click(function() {
  		calcular_aut();
	});
	
	
});

function calcular_aut() {
	
	if($("#radio_2016").is(":checked"))
		periodo = 2016;
	else
		periodo = 2017;
		
	console.debug('Periodo: '+ periodo);
	
	$('#deduccionEspecial').text('- $'+ DEDUCCION_ESPECIAL[periodo].toFixed(2));
	$('#gananciaNoImponible').text('- $'+ GANANCIA_NO_IMPONIBLE[periodo].toFixed(2));
	
	var ingresos = Number($('#ingresos').val());
	console.debug('ingresos: '+ ingresos);
	
	var egresos = Number($('#gastos').val());
	console.debug('egresos: '+ egresos);
	
	var resultado_neto = ingresos - egresos;
	console.debug('resultado neto: '+ resultado_neto);
	$('#resultado_neto').text('$'+resultado_neto.toFixed(2));
	
	
	// cálculo de deducciones generales
	var dg = 0;
	
	// descuento los aportes autonomos hechos en el año
	/*
	var autonomos = 0;
	autonomos = 12 * APORTES_AUT[document.getElementById("cat_autonomos").selectedIndex];	
	dg += autonomos;
	console.debug('autónomos: '+ autonomos);
	*/
	
	// servicio doméstico
	var servicioDomestico = Number($('#servicioDomestico').val());
	var servicioDomestico_deducible = 0;
	if (servicioDomestico > SERVICIO_DOMESTICO_MAX)
		servicioDomestico_deducible = SERVICIO_DOMESTICO_MAX;
	else
		servicioDomestico_deducible = servicioDomestico;
	dg += servicioDomestico_deducible;
	console.debug('servicio domestico: '+ servicioDomestico_deducible);

	/*
	var seguroRetiro = Number($('#seguroRetiro').val());
	var seguroRetiro_deducible = 0;
	if (seguroRetiro > SEGURO_RETIRO_MAX)
		seguroRetiro_deducible = SEGURO_RETIRO_MAX;
	else
		seguroRetiro_deducible = seguroRetiro;
	dg += seguroRetiro_deducible;
	console.debug('seguro retiro: '+ seguroRetiro_deducible);
	*/
	
	// seguro de vida
	var seguroVida = Number($('#seguroVida').val());
	var seguroVida_deducible = 0;
	if (seguroVida > SEGURO_VIDA_MAX)
		seguroVida_deducible = SEGURO_VIDA_MAX;
	else
		seguroVida_deducible = seguroVida;
	dg += seguroVida_deducible;
	console.debug('seguro vida: '+ seguroVida_deducible);
	
	// Otras deducciones
	var otras = 0;
	//var otras = Number($('#otras_deducciones').val());
	dg += otras;
	
	// donaciones
	var donaciones = Number($('#donaciones').val());
	var donaciones_deducibles = 0;
	if ((resultado_neto - otras - seguroVida_deducible) * PORCENTAJE_DONACIONES/100 > donaciones)
		donaciones_deducibles = donaciones;
	else
		donaciones_deducibles = (resultado_neto - otras - seguroVida_deducible ) * PORCENTAJE_DONACIONES/100;
	dg += donaciones_deducibles;
	console.debug('donaciones: '+ donaciones_deducibles);
		
	// cuotas médicas
	var cuotas_medicas = Number($('#cuotasMedicas').val());
	var cuotas_medicas_deducibles = 0;
	if ((resultado_neto - otras - seguroVida_deducible) * PORCENTAJE_CUOTAS_MEDICAS/100 > cuotas_medicas)
		cuotas_medicas_deducibles = cuotas_medicas;
	else
		cuotas_medicas_deducibles = (resultado_neto - otras - seguroVida_deducible ) * PORCENTAJE_CUOTAS_MEDICAS/100;
	dg += cuotas_medicas_deducibles;
	console.debug('cuotas medicas: '+ cuotas_medicas_deducibles);
		
	// honorarios médicos
	var honorarios_medicos = Number($('#honorariosMedicos').val()) * 0.4;
	var honorarios_medicos_deducibles = 0;
	if ((resultado_neto - otras - seguroVida_deducible) * PORCENTAJE_HONORARIOS_MEDICOS/100 > honorarios_medicos)
		honorarios_medicos_deducibles = honorarios_medicos;
	else
		honorarios_medicos_deducibles = (resultado_neto - otras - seguroVida_deducible) * PORCENTAJE_HONORARIOS_MEDICOS/100;
	dg += honorarios_medicos_deducibles
	console.debug('honorarios medicos: '+ honorarios_medicos_deducibles);
		
	// intereses
	var intereses = Number($('#intereses').val());
	var int_men_max = 0;
	if (intereses <= INTERESES_MAX)
		int_men_max = intereses;
	else
		int_men_max = INTERESES_MAX;
	
	var intereses_deducibles = 0;
	if ((resultado_neto - otras - seguroVida_deducible - donaciones_deducibles - cuotas_medicas_deducibles - honorarios_medicos_deducibles) <=  int_men_max)
		intereses_deducibles = resultado_neto - otras - seguroVida_deducible - donaciones_deducibles - cuotas_medicas_deducibles - honorarios_medicos_deducibles;
	else
		intereses_deducibles = int_men_max;
	dg += intereses_deducibles;
	console.debug('intereses hipotecarios: '+ intereses_deducibles);
	

	
	// ALQUILERES
	var alquileres = Number($('#alquileres').val());
	console.debug('ALQUILER_MAX: '+ ALQUILER_MAX[periodo]);
	console.debug('alquileres ingresados: '+ alquileres);
	var alq_min_max = 0;
	if (alquileres > 0)
	{
		if ((alquileres * 0.4) <= ALQUILER_MAX[periodo])
			alq_min_max = alquileres * 0.4;
		else
			alq_min_max = ALQUILER_MAX[periodo];
	}
	console.debug('alq_min_max: '+ alq_min_max);
	var alquiler_deducible = 0;
	if ((resultado_neto - otras - seguroVida_deducible - donaciones_deducibles - cuotas_medicas_deducibles - honorarios_medicos_deducibles - intereses_deducibles) <=  alq_min_max)
		alquiler_deducible = resultado_neto - otras - seguroVida_deducible - donaciones_deducibles - cuotas_medicas_deducibles - honorarios_medicos_deducibles - intereses_deducibles;
	else
		alquiler_deducible = alq_min_max;
	dg += alquiler_deducible;
	console.debug('alquileres: '+ alquiler_deducible);
	
	
	console.debug('deducciones generales: '+ dg);
	$('#deduccionGeneral').text('- $'+ dg.toFixed(2));
	


	// deducciones personales
	var conyugue =$("input[name='conyuge']:checked").val();
	console.debug('conyugue: '+ conyugue);
	$('#deduccionConyugue').text('- $'+ (conyugue*DEDUCCION_CONYUGUE[periodo]).toFixed(2));
	
	var hijos = document.getElementById("hijos").options[document.getElementById("hijos").selectedIndex].value;
	console.debug('hijos: '+ hijos);	
	$('#deduccionHijo').text('- $'+ (hijos*DEDUCCION_HIJO[periodo]).toFixed(2));
	
	
	
	// ganancia neta sujeta a impuesto
	var ganancia_neta = ingresos - egresos - dg - DEDUCCION_ESPECIAL[periodo] - GANANCIA_NO_IMPONIBLE[periodo] - hijos*DEDUCCION_HIJO[periodo] - conyugue*DEDUCCION_CONYUGUE[periodo];
	console.debug('ganancia neta: '+ ganancia_neta);

	$('#gananciaNeta').text('$'+ganancia_neta.toFixed(2));	
	
		
	var n = minimos.length;
	var porcentaje = 0;
	var imp_acumulado = 0;
	var minimo = 0;
	var base = 0;
	for (i = 0; i < n; i++)
	{
		if (ganancia_neta >= minimos[periodo][i])
		{
			base = bases[periodo][i];
			porcentaje = porcentajes[periodo][i];
			minimo = minimos[periodo][i];
		}
		else
			break;
	}
	console.debug('alicuota: '+ porcentaje +'%');
	console.debug('base: '+ base);	
	console.debug('minimo: '+ minimo);	
	
	$('#alicuota').text(porcentaje +'%');
	$('#alicuota_help').text('Paga $'+ base +' + el '+ porcentaje +'% de la diferencia entre la ganancia neta ($'+ ganancia_neta.toFixed(2) +') y $'+ minimo +'.');
	 
	var impuesto = base + ((ganancia_neta - minimo) * porcentaje / 100);
	$('#impuestoAnual').text('$'+ impuesto.toFixed(2));
	
	var alicuotaEfectiva = (impuesto / (ingresos - egresos));
	$('#alicuotaEfectiva').text(porcentaje +'%');
	console.debug('alicuota efectiva promedio: '+ alicuotaEfectiva);
}

//function calcular(){
//var a=$("#sueldoBruto").val(),b=$("input[name='conyuge']:checked").val(),c=$("input[name='jubilado']:checked").val(),d=$("input[name='patagonico']:checked").val(),e=$("#alquiler").val(),f=12*e*.4>ALQUILER?ALQUILER:12*e*.4,h=document.getElementById("hijos"),j=h.options[h.selectedIndex].value,k=0;k=0==c?.17*a>TOPE_APORTES?a-TOPE_APORTES:.83*a:.06*a>TOPE_APORTES?a-TOPE_APORTES:.94*a;var l=13*k,m=(MINIMO_NO_IMPONIBLE+ADICIONAL_4TA_CATEGORIA)*(1.22*d+(1-d));g=(m+CONYUGE*b+HIJO*j+f)*(1-c)+c*(JUBILADO+f),i=0,g<l&&(i=l-g);for(var n=[0,0,0,0,0,0,0,0,0],o=0;o<n.length&&(n[o]=calcularValorEscala(o,i),n[o]==fijosEscalas[o]);o++);for(var p=o,q=0,o=0;o<n.length;o++)q+=n[o];q=q.toFixed(2),$("#impuestoAnual").text("$"+q);var r=(q/13).toFixed(2);$("#impuestoMensual").text("$"+r);var s=r/a*100;$("#alicuota").text(s.toFixed(2)+"%");var t=0==s?0:100*porcentajesEscalas[p];$("#alicuotaMarginal").text(t.toFixed(2)+"%");var u=k-r;$("#sueldoEnMano").text("$"+Math.round(u)+".00")}function calcularValorEscala(a,b){var c=0,d=0;return a>0&&(d=topesEscalas[a-1]),c=b<topesEscalas[a]?(b-d)*porcentajesEscalas[a]:fijosEscalas[a]}$(document).ready(function(){$("#calcular").on("click",function(){calcular()}),$(document).keypress(function(a){13==a.keyCode&&(a.preventDefault(),calcular())}),$("input[name='jubilado']").click(function(){$("input[name='conyuge']").attr({disabled:1==$(this).val()}),$("input[name='patagonico']").attr({disabled:1==$(this).val()})})});var topesEscalas=[2e4,4e4,6e4,8e4,12e4,16e4,24e4,32e4,99999999],porcentajesEscalas=[.05,.09,.12,.15,.19,.23,.27,.31,.35],fijosEscalas=[1e3,1800,2400,3e3,7600,9200,21600,24800],MINIMO_NO_IMPONIBLE=51967,ADICIONAL_4TA_CATEGORIA=249441.6,CONYUGE=48447,HIJO=24432,TOPE_APORTES=10896.32;JUBILADO=407592,ALQUILER=51967;
