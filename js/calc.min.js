var DEDUCCION_ESPECIAL = 42318;
var DEDUCCION_CONYUGUE = 39778;
var DEDUCCION_HIJO = 19889;
var GANANCIA_NO_IMPONIBLE = 42318;

var SEGURO_RETIRO_MAX = 1261.16;
var SERVICIO_DOMESTICO_MAX = 42318;
var SEGURO_VIDA_MAX = 996.23;
var INTERESES_MAX = 20000;
var PORCENTAJE_DONACIONES = 5;
var PORCENTAJE_CUOTAS_MEDICAS = 5;
var PORCENTAJE_HONORARIOS_MEDICOS = 5;

// valores 2016
var minimos = [0, 10000, 20000, 30000, 60000, 90000, 120000];
var porcentajes = [9, 14, 19, 23, 27, 31, 35];
var bases = [0, 900, 2300, 4200, 11100, 19200, 28500];


// valores 2017
//var minimos = [0, 20000, 40000, 60000, 80000, 120000, 160000, 240000, 320000];
//var porcentajes = [5, 9, 12, 15, 19, 23, 27, 31, 35];
//var bases = [0, 1000, 2800, 5200, 8200, 15800, 25000, 46600, 71400];


var APORTES_AUT = [1198.08, 1470.72, 1608.60, 1966.08, 2150.40, 2941.44, 3217.20, 4911.36, 5371.80, 6869.76, 9818.88, 10739.40, 14734.08, 18432, 18432];


$(function() {
	
	$('#deduccionEspecial').text('$'+ DEDUCCION_ESPECIAL.toFixed(2));
	$('#deduccionConyugue').text('$'+ DEDUCCION_CONYUGUE.toFixed(2));
	$('#deduccionHijo').text('$'+ DEDUCCION_HIJO.toFixed(2));
	$('#gananciaNoImponible').text('$'+ GANANCIA_NO_IMPONIBLE.toFixed(2));
	$('#deduccSegVidaMax').text('$'+ SEGURO_VIDA_MAX.toFixed(2));
	$('#deduccSegRetMax').text('$'+ SEGURO_RETIRO_MAX.toFixed(2));
	$('#porcDonaciones').text(PORCENTAJE_DONACIONES +'%');
	$('#porcCuotasMed').text(PORCENTAJE_CUOTAS_MEDICAS +'%');
	$('#porcHonorariosMed').text(PORCENTAJE_HONORARIOS_MEDICOS +'% del 40% facturado');
	$('#deduccionIntereses').text('$'+ INTERESES_MAX.toFixed(2));
	$('#deduccionServicioDomestico').text('$'+ SERVICIO_DOMESTICO_MAX.toFixed(2));
	

    $("#calcular").click(function() {
  		calcular_aut();
	});
	
	
});

function calcular_aut() {
	
	var ingresos = Number($('#ingresos').val());
	console.debug('ingresos: '+ ingresos);
	
	var egresos = Number($('#gastos').val());
	console.debug('egresos: '+ egresos);
	
	var resultado_neto = ingresos - egresos;
	console.debug('resultado neto: '+ resultado_neto);
	
	// aportes autonomos
	var autonomos = 0;
	autonomos = APORTES_AUT[document.getElementById("cat_autonomos").selectedIndex];
	
	// cálculo de deducciones generales
	var dg = 0;
	
	dg += autonomos;
	console.debug('autónomos: '+ autonomos);
	
	var servicioDomestico = Number($('#servicioDomestico').val()) * 12;
	var servicioDomestico_deducible = 0;
	if (servicioDomestico > SERVICIO_DOMESTICO_MAX)
		servicioDomestico_deducible = SERVICIO_DOMESTICO_MAX;
	else
		servicioDomestico_deducible = servicioDomestico;
	dg += servicioDomestico_deducible;
	console.debug('servicio domestico: '+ servicioDomestico_deducible);

	var seguroRetiro = Number($('#seguroRetiro').val());
	var seguroRetiro_deducible = 0;
	if (seguroRetiro > SEGURO_RETIRO_MAX)
		seguroRetiro_deducible = SEGURO_RETIRO_MAX;
	else
		seguroRetiro_deducible = seguroRetiro;
	dg += seguroRetiro_deducible;
	console.debug('seguro retiro: '+ seguroRetiro_deducible);
	
	var seguroVida = Number($('#seguroVida').val());
	var seguroVida_deducible = 0;
	if (seguroVida > SEGURO_VIDA_MAX)
		seguroVida_deducible = SEGURO_VIDA_MAX;
	else
		seguroVida_deducible = seguroVida;
	dg += seguroVida_deducible;
	console.debug('seguro vida: '+ seguroVida_deducible);
	
	var donaciones = Number($('#donaciones').val());
	var donaciones_deducibles = 0;
	if ((resultado_neto - autonomos - seguroVida - seguroRetiro) * PORCENTAJE_DONACIONES/100 > donaciones)
		donaciones_deducibles = donaciones;
	else
		donaciones_deducibles = (resultado_neto - autonomos - seguroVida - seguroRetiro) * PORCENTAJE_DONACIONES/100;
	dg += donaciones_deducibles;
	console.debug('donaciones: '+ donaciones_deducibles);
		
		
	var cuotas_medicas = Number($('#cuotasMedicas').val());
	var cuotas_medicas_deducibles = 0;
	if ((resultado_neto - autonomos - seguroVida - seguroRetiro) * PORCENTAJE_CUOTAS_MEDICAS/100 > cuotas_medicas)
		cuotas_medicas_deducibles = cuotas_medicas;
	else
		cuotas_medicas_deducibles = (resultado_neto - autonomos - seguroVida - seguroRetiro) * PORCENTAJE_CUOTAS_MEDICAS/100;
	dg += cuotas_medicas_deducibles;
	console.debug('cuotas medicas: '+ cuotas_medicas_deducibles);
		
	var honorarios_medicos = Number($('#honorariosMedicos').val()) * 0.4;
	var honorarios_medicos_deducibles = 0;
	if ((resultado_neto - autonomos - seguroVida - seguroRetiro) * PORCENTAJE_HONORARIOS_MEDICOS/100 > honorarios_medicos)
		honorarios_medicos_deducibles = honorarios_medicos;
	else
		honorarios_medicos_deducibles = (resultado_neto - autonomos - seguroVida - seguroRetiro) * PORCENTAJE_HONORARIOS_MEDICOS/100;
	dg += honorarios_medicos_deducibles
	console.debug('honorarios medicos: '+ honorarios_medicos_deducibles);
		
	var intereses = Number($('#intereses').val());
	var int_men_max = 0;
	if (intereses <= INTERESES_MAX)
		int_men_max = intereses;
	else
		int_men_max = INTERESES_MAX;
	
	var intereses_deducibles = 0;
	if ((resultado_neto - autonomos - seguroVida - seguroRetiro - donaciones_deducibles - cuotas_medicas_deducibles - honorarios_medicos_deducibles) <=  int_men_max)
		intereses_deducibles = resultado_neto - autonomos - seguroVida - seguroRetiro - donaciones_deducibles - cuotas_medicas_deducibles - honorarios_medicos_deducibles;
	else
		intereses_deducibles = int_men_max;
	dg += intereses_deducibles;
	console.debug('intereses hipotecarios: '+ intereses_deducibles);
		
	var deducciones_grales = Number($('#deducciones_grales').val());
	console.debug('deducciones generales: '+ dg);
	
	
	var conyugue =$("input[name='conyuge']:checked").val();
	console.debug('conyugue: '+ conyugue);
	
	var hijos = document.getElementById("hijos").options[document.getElementById("hijos").selectedIndex].value;
	console.debug('hijos: '+ hijos);
	
	var ganancia_neta = ingresos - egresos - dg - DEDUCCION_ESPECIAL - GANANCIA_NO_IMPONIBLE - hijos*DEDUCCION_HIJO - conyugue*DEDUCCION_CONYUGUE;
	console.debug('ganancia neta: '+ ganancia_neta);

	$('#gananciaNeta').text('$'+ganancia_neta.toFixed(2));	
	
	
	var n = minimos.length;
	var porcentaje = 0;
	var imp_acumulado = 0;
	var minimo = 0;
	var base = 0;
	for (i = 0; i < n; i++)
	{
		if (ganancia_neta >= minimos[i])
		{
			base = bases[i];
			porcentaje = porcentajes[i];
			minimo = minimos[i];
		}
		else
			break;
	}
	console.debug('alicuota: '+ porcentaje +'%');
	console.debug('base: '+ base);	
	console.debug('minimo: '+ minimo);	
	
	$('#alicuota').text(porcentaje +'%');
	 
	var impuesto = base + ((ganancia_neta - minimo) * porcentaje / 100);
	$('#impuestoAnual').text('$'+ impuesto.toFixed(2));
	
}

//function calcular(){
//var a=$("#sueldoBruto").val(),b=$("input[name='conyuge']:checked").val(),c=$("input[name='jubilado']:checked").val(),d=$("input[name='patagonico']:checked").val(),e=$("#alquiler").val(),f=12*e*.4>ALQUILER?ALQUILER:12*e*.4,h=document.getElementById("hijos"),j=h.options[h.selectedIndex].value,k=0;k=0==c?.17*a>TOPE_APORTES?a-TOPE_APORTES:.83*a:.06*a>TOPE_APORTES?a-TOPE_APORTES:.94*a;var l=13*k,m=(MINIMO_NO_IMPONIBLE+ADICIONAL_4TA_CATEGORIA)*(1.22*d+(1-d));g=(m+CONYUGE*b+HIJO*j+f)*(1-c)+c*(JUBILADO+f),i=0,g<l&&(i=l-g);for(var n=[0,0,0,0,0,0,0,0,0],o=0;o<n.length&&(n[o]=calcularValorEscala(o,i),n[o]==fijosEscalas[o]);o++);for(var p=o,q=0,o=0;o<n.length;o++)q+=n[o];q=q.toFixed(2),$("#impuestoAnual").text("$"+q);var r=(q/13).toFixed(2);$("#impuestoMensual").text("$"+r);var s=r/a*100;$("#alicuota").text(s.toFixed(2)+"%");var t=0==s?0:100*porcentajesEscalas[p];$("#alicuotaMarginal").text(t.toFixed(2)+"%");var u=k-r;$("#sueldoEnMano").text("$"+Math.round(u)+".00")}function calcularValorEscala(a,b){var c=0,d=0;return a>0&&(d=topesEscalas[a-1]),c=b<topesEscalas[a]?(b-d)*porcentajesEscalas[a]:fijosEscalas[a]}$(document).ready(function(){$("#calcular").on("click",function(){calcular()}),$(document).keypress(function(a){13==a.keyCode&&(a.preventDefault(),calcular())}),$("input[name='jubilado']").click(function(){$("input[name='conyuge']").attr({disabled:1==$(this).val()}),$("input[name='patagonico']").attr({disabled:1==$(this).val()})})});var topesEscalas=[2e4,4e4,6e4,8e4,12e4,16e4,24e4,32e4,99999999],porcentajesEscalas=[.05,.09,.12,.15,.19,.23,.27,.31,.35],fijosEscalas=[1e3,1800,2400,3e3,7600,9200,21600,24800],MINIMO_NO_IMPONIBLE=51967,ADICIONAL_4TA_CATEGORIA=249441.6,CONYUGE=48447,HIJO=24432,TOPE_APORTES=10896.32;JUBILADO=407592,ALQUILER=51967;